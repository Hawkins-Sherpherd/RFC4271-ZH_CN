# UPDATE 报文格式

UPDATE 报文用于在 BGP 对等体之间传输路由信息。UPDATE 报文中的信息可用于构建一个描述自治系统间的关系的拓扑图。通过应用有待讨论的规则，路由信息环路和其它的异常情况可以被检测到，并从自治系统间路由移除。

一个 UPDATE 报文用于向对等体广播带有共享常规路径属性的可用路由，或撤回多个不可用路由（详见 [3.1](../Section03/3.1.md)）。一条 UPDATE 报文**可能**同时广播可用路由和撤回多条不可用路由。UPDATE 报文恒定包括固定尺寸的 BGP 报文头，而且还有其它的字段，如下图所示（请注意，一些在此显示的字段可能并不会出现在每个 UPDATE 报文中都出现）：


```
+-----------------------------------------------------+
|   Withdrawn Routes Length (2 octets)                |
+-----------------------------------------------------+
|   Withdrawn Routes (variable)                       |
+-----------------------------------------------------+
|   Total Path Attribute Length (2 octets)            |
+-----------------------------------------------------+
|   Path Attributes (variable)                        |
+-----------------------------------------------------+
|   Network Layer Reachability Information (variable) |
+-----------------------------------------------------+
```

&emsp;

## 撤回路由长度（Withdrawn Routes Length）：

这个2八位元长度的无符号整数表示以八位元为单位的撤回路由字段的总长度。这个值使得 NLRI 字段的长度能够被确定，如下文所述。

该字段值为0代表没有撤回的路由，也意味着这个 UPDATE 报文里不会有撤回路由字段。

&emsp;

## 撤回路由（Withdrawn Routes）：

这是个可变长的字段，它包含一个由表示要撤回路由的 IP 地址前缀列表构成。每个 IP 地址前缀都以下图所示的两元组 <长度，前缀> 格式组织而成：

```
+---------------------------+
|   Length (1 octet)        |
+---------------------------+
|   Prefix (variable)       |
+---------------------------+
```

对这些字段的使用和含义如下文所述：

* a) 长度（Length）：

&emsp;&emsp;&emsp;&emsp;长度字段表示以位为单位的 IP 地址前缀长度。当长度的值为0时意味着这个前缀匹配所有 IP 地址（在前缀自身为全0八位元组的情况下）。

* b) 前缀（Prefix）：
  
&emsp;&emsp;&emsp;&emsp;前缀字段包含一个 IP 地址前缀，接在最小的使前缀的尾端能够确定在八位元组之上的边界的以位为单位的数字之后。请注意，尾端位数的值与此是不相关的。

&emsp;

## 路径属性总长度（Total Path Attribute Length）：

这个2八位元长度的无符号整数表示以八位元为单位的路径属性字段总长度。这个值使得 NLRI 字段的长度能够被确定，如下文所述。

该字段值为0表示这个 UPDATE 报文既没有 NLRI 字段也没有路径属性字段。

&emsp;

## 路径属性（Path Attributes）：

一个出现在除了仅有撤回路由的 UPDATE 报文之外的所有 UPDATE 报文中的可变长的路径属性序列。每个路径属性都由 <路径属性，类型，属性长度，属性值> 的可变长元组组成。

路径属性是一个2八位元长度的字段，由属性标识八位元和跟在其后的属性类型代码八位元组成。

```
0                   1
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Attr. Flags  |Attr. Type Code|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

属性标识八位元的高位（第0位）是可选性位（Optional Bit）。它定义该属性是可选的（为1时）还是公认（Well-Known）的（为0时）。

属性标识八位元的第二高位（第1位）是传递性位（Transitive Bit）。它定义一个可选属性是可传递的（为1时）还是不可传递的（为0时）。

对于公认属性，传递位**必须**设置为1。（详见[第5章](../Section05/5.md)对可传递属性的讨论。）

属性标识八位元第三高位（第2位）是完整性位（Partial bit）。它定义可传递的可选属性包含的信息是完整的（为0时）还是不完整（为1时）的。对于公认属性和不可传递的可选属性而言，该位**必须**设置为0。

属性标识八位元第四高位（第3位）是拓展长度位（Extended Length bit）。它定义一个属性的长度用一个八位元表示（为0时）还是用两个八位元表示（为1时）。

而属性标识八位元低位的四个位现在尚未有用途。它们在发送时**必须**设置为0并且**必须**在接收时忽略它们。

属性类型代码八位元包含属性类型代码。现在有定义的属性类型代码在[第5章](../Section05/5.md)中有所提及。

如果属性标识八位元中的拓展长度位被设置位0，那么路径属性的第三个八位元将表示以八位元为单位的属性数据长度。

如果属性标识八位元中的拓展长度位被设置位1，那么路径属性的第三和第四个八位元将共同用于表示以八位元为单位的属性数据长度。

路径属性中另外的八位元所表达的属性值由属性标识和属性类型代码共同解释。以下是目前支持的属性代码以及它们对应的属性值：

* a) ORIGIN（类型代码1）：

&emsp;&emsp;&emsp;&emsp;ORIGIN 是一个公认必须属性，它定义了路径信息的起源。其数据八位元所表达的值可被预想为如下值：

|值        |含义
|----------|--------
|0         |IGP - 网络层可达性信息是源 AS 内部通过 IGP 学习得来
|1         |EGP - 网络层可达性信息是通过 EGP 协议 [[RFC904]](https://www.rfc-editor.org/rfc/rfc904.html) 学习得来
|2         |INCOMPLETE - 网络可达性是通过其它途径学习得来

&emsp;&emsp;&emsp;&emsp;对此属性的使用的定义存在于[章节5.1.1](../Section05/5.1/5.1.1.md)中。

* b) AS_PATH（类型代码2）：

&emsp;&emsp;&emsp;&emsp;AS_PATH 是一个公认必须属性，由自治系统路径分段的序列构成。每个自治系统路径分段都表示为 <路径分段类型，路径分段长度，路径分段值> 的三元组。

&emsp;&emsp;&emsp;&emsp;路径分段类型（Path Segment Type）是一个1八位元长度的字段，具有如下定义的值：

|值         |分段类型
|-----------|-------------
|1          |AS_SET：对 UPDATE 报文内路由经过的自治系统的无序组合
|2          |AS_SEQUENCE：对 UPDATE 报文内路由经过的自治系统的有序组合

&emsp;&emsp;&emsp;&emsp;路径分段长度（Path Segment Length）是一个1八位元长度的字段，包含路径分段值字段中的自治系统的数量的值（而非以八位元为单位）。

&emsp;&emsp;&emsp;&emsp;路径属性值（Path Segment Value）包含了一个或更多的自治系统号码，每个自治系统号码都由一个2八位元长度的字段组成。

&emsp;&emsp;&emsp;&emsp;对此属性的使用的定义存在于[章节5.1.2](../Section05/5.1/5.1.2.md)中。

* c) NEXT_HOP（类型代码3）：

&emsp;&emsp;&emsp;&emsp;这是一个公认必须属性，它定义了**应该**被路由器作为 UPDATE 报文里的 NLRI 字段中的目的地的下一跳的单播的 IP 地址。

&emsp;&emsp;&emsp;&emsp;对此属性的使用的定义存在于[章节5.1.3](../Section05/5.1/5.1.3.md)中。

* d) MULTI_EXIT_DISC（类型代码4）：

&emsp;&emsp;&emsp;&emsp;这是一个可选不可传递属性，由一个4八位元长度无符号整数组成。这个属性的值**可能**被 BGP Speaker 用于在与邻居 AS 的多个入口点之间做区分的决策进程。

&emsp;&emsp;&emsp;&emsp;对此属性的使用的定义存在于[章节5.1.4](../Section05/5.1/5.1.4.md)中。

* e) LOCAL_PREF（类型代码5）：

&emsp;&emsp;&emsp;&emsp;LOCAL_PREF 是由一个4八位元无符号整数组成的公认属性。一个 BGP Speaker 使用它来通知其它内部对等体广播该信息的对等体对于它广播的路由优先级度量。

&emsp;&emsp;&emsp;&emsp;对此属性的使用的定义存在于[章节5.1.5](../Section05/5.1/5.1.5.md)中。

* f) ATOMIC_AGGREGATE（类型代码6）：

&emsp;&emsp;&emsp;&emsp;ATOMIC_AGGREGATE 是一个长度为0的公认可选属性。

&emsp;&emsp;&emsp;&emsp;对此属性的使用的定义存在于[章节5.1.6](../Section05/5.1/5.1.6.md)中。

* g) AGGREGATOR（类型代码7）：

&emsp;&emsp;&emsp;&emsp;AGGREGATOR 是一个长度为6的可选可传递属性。这个属性包含了最后一个通告这个聚合路由的自治系统号码（由2八位元组成），之后便是通告这个消息的 BGP Speaker 的 IP 地址（由4八位元组成）。这个地址**应该**与该 Speaker 的 BGP 标识表示的地址一致。

&emsp;&emsp;&emsp;&emsp;对此属性的使用的定义存在于[章节5.1.7](../Section05/5.1/5.1.7.md)中。

&emsp;

## 网络层可达性信息（Network Layer Reachability Information, NLRI）：

这个可变长的字段包含了一个由 IP 地址前缀构成的列表。以八位元为单位的 NLRI 长度并没有显式的表达，但可以如此计算：

UPDATE 报文长度减去23减去路径属性总长度再减去撤回路由长度

UPDATE 报文长度的值指的是 BGP 报文头部的固定部分长度，定义属性可变长部分长度的路径属性总长度的值和撤回路由总长度的值的相加，而23是固定的 BGP 报文头部的长度，路径属性总长度字段和撤回路由长度的值的综合。

可达性信息（Reachability Information）由一个或多个 <长度，前缀> 格式的二元组组成，如下图所示：

```
+---------------------------+
|   Length (1 octet)        |
+---------------------------+
|   Prefix (variable)       |
+---------------------------+
```

这些字段的使用和含义如下文所述：

* a) 长度（Length）：

&emsp;&emsp;&emsp;&emsp;长度字段表示以位为单位的 IP 地址前缀长度。当长度的值为0时意味着这个前缀匹配所有 IP 地址（在前缀自身为全0八位元组的情况下）。

* b) 前缀（Prefix）：

&emsp;&emsp;&emsp;&emsp;前缀字段包含一个 IP 地址前缀，接在最小的使前缀的尾端能够确定在八位元组之上的边界的以位为单位的数字之后。请注意，尾端位数的值与此是不相关的。

&emsp;

UPDATE 报文的最小长度为23个八位元————19个八位元用于固定的报文头，2个八位元用于撤回路由长度，外加2个八位元用于路径属性总长度（撤回路由长度和路径属性总长度的值均为0）。

一个 UPDATE 报文可以至多广播一组路径属性，并有多个目的地，令这些目的地共享这些路径属性。所有包含在给定的 UPDATE 报文中的路径属性应用在承载于 NLRI 字段的所有目的地上。

一个 UPDATE 报文可以列出多个要撤回的路由。每个这样的路由都会通过其目的地来标识（以 IP 前缀的形式），这将无歧义地在先前向其广播该路由的 BGP Speaker 之间的连接的的上下文中标识路由。

一个 UPDATE 报文可能只广播要撤回的路由，在此情况下报文将不包含路径属性和 NLRI 。反过来讲，只广播可用路由的情况也是有的，在这种情况下撤回路由字段将不会出现。

一个 UPDATE 报文**不应该**在撤回路由和 NLRI 字段里包含有相同的地址前缀。但是，一个 BGP Speaker **必须**能够处理这种形式的 UPDATE 报文。一个 BGP Speaker **应该**视这种形式的 UPDATE 报文中的撤回路由部分不包含这个地址前缀。